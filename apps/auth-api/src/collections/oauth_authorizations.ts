import {defineCollection, uid} from '@paybilldev/sequelize';

export default defineCollection({
  dumpRules: {group: 'auth'},
  migrationRules: ['schema-only', 'overwrite'],
  name: 'oauth_authorizations',
  title: 'OAuth Authorizations',
  comment:
    'Auth: Stores OAuth2/OIDC authorization requests and issued authorization codes',
  model: 'OAuthAuthorizationModel',
  createdBy: false,
  updatedBy: false,
  createdAt: true,
  updatedAt: false,
  logging: true,
  shared: true,
  fields: [
    {
      name: 'id',
      type: 'uuid',
      primaryKey: true,
      allowNull: false,
      interface: 'id',
      comment: 'Primary key for the authorization record',
      uiSchema: {
        type: 'string',
        title: 'Authorization ID (PK)',
        'x-component': 'Input',
        'x-read-pretty': true,
      },
    },
    {
      name: 'authorization_id',
      type: 'string',
      allowNull: false,
      unique: true,
      interface: 'input',
      comment: 'Public unique authorization request identifier',
      length: 255,
      validation: {
        type: 'string',
        rules: [{key: `r_${uid()}`, name: 'max', args: {length: 255}}],
      },
      uiSchema: {
        type: 'string',
        title: 'Authorization ID (Unique)',
        'x-component': 'Input',
      },
    },
    {
      name: 'oauth',
      type: 'belongsTo',
      foreignKey: 'client_id',
      target: 'oauth_clients',
      targetKey: 'id',
      interface: 'm2o',
      comment: 'OAuth client that initiated the authorization request',
      uiSchema: {
        type: 'array',
        title: 'Client ID',
        'x-component': 'AssociationField',
        'x-component-props': {
          multiple: false,
          fieldNames: {label: 'id', value: 'id'},
        },
      },
    },
    {
      name: 'user',
      type: 'belongsTo',
      foreignKey: 'user_id',
      target: 'users',
      targetKey: 'id',
      interface: 'm2o',
      comment: 'User who granted or denied the authorization',
      uiSchema: {
        type: 'array',
        title: 'User ID',
        'x-component': 'AssociationField',
        'x-component-props': {
          multiple: false,
          fieldNames: {label: 'id', value: 'id'},
        },
      },
    },
    {
      name: 'redirect_uri',
      type: 'string',
      allowNull: false,
      interface: 'input',
      comment: 'Client redirect URI used after authorization',
      length: 2048,
      validation: {
        type: 'string',
        rules: [{key: `r_${uid()}`, name: 'max', args: {length: 2048}}],
      },
      uiSchema: {
        type: 'string',
        title: 'Redirect URI',
        'x-component': 'Input',
      },
    },
    {
      name: 'scope',
      type: 'string',
      allowNull: false,
      interface: 'input',
      comment: 'Requested OAuth scopes',
      length: 4096,
      validation: {
        type: 'string',
        rules: [{key: `r_${uid()}`, name: 'max', args: {length: 4096}}],
      },
      uiSchema: {
        type: 'string',
        title: 'Scope',
        'x-component': 'Input',
      },
    },
    {
      name: 'state',
      type: 'string',
      interface: 'input',
      comment: 'Opaque value to prevent CSRF attacks',
      length: 4096,
      validation: {
        type: 'string',
        rules: [{key: `r_${uid()}`, name: 'max', args: {length: 4096}}],
      },
      uiSchema: {
        type: 'string',
        title: 'State',
        'x-component': 'Input',
      },
    },
    {
      name: 'resource',
      type: 'string',
      interface: 'input',
      comment: 'Resource indicator per RFC 8707',
      length: 2048,
      validation: {
        type: 'string',
        rules: [{key: `r_${uid()}`, name: 'max', args: {length: 2048}}],
      },
      uiSchema: {
        type: 'string',
        title: 'Resource',
        'x-component': 'Input',
      },
    },
    {
      name: 'code_challenge',
      type: 'string',
      interface: 'input',
      comment: 'PKCE code challenge value',
      length: 128,
      validation: {
        type: 'string',
        rules: [{key: `r_${uid()}`, name: 'max', args: {length: 128}}],
      },
      uiSchema: {
        type: 'string',
        title: 'Code Challenge',
        'x-component': 'Input',
      },
    },
    {
      name: 'code_challenge_method',
      type: 'string',
      interface: 'select',
      comment: 'PKCE transformation method',
      uiSchema: {
        type: 'string',
        title: 'Code Challenge Method',
        'x-component': 'Select',
        enum: [
          {label: 'S256', value: 's256'},
          {label: 'Plain', value: 'plain'},
        ],
      },
    },
    {
      name: 'response_type',
      type: 'string',
      defaultValue: 'code',
      interface: 'select',
      comment: 'OAuth response type (authorization code flow only)',
      uiSchema: {
        type: 'string',
        title: 'Response Type',
        'x-component': 'Select',
        enum: [{label: 'Code', value: 'code'}],
      },
    },
    {
      name: 'nonce',
      type: 'string',
      interface: 'input',
      comment: 'OIDC nonce for replay protection',
      length: 255,
      validation: {
        type: 'string',
        rules: [{key: `r_${uid()}`, name: 'max', args: {length: 255}}],
      },
      uiSchema: {
        type: 'string',
        title: 'Nonce',
        'x-component': 'Input',
      },
    },
    {
      name: 'status',
      type: 'string',
      defaultValue: 'pending',
      interface: 'select',
      comment: 'Current lifecycle status of the authorization request',
      uiSchema: {
        type: 'string',
        title: 'Status',
        'x-component': 'Select',
        enum: [
          {label: 'Pending', value: 'pending'},
          {label: 'Approved', value: 'approved'},
          {label: 'Denied', value: 'denied'},
          {label: 'Expired', value: 'expired'},
        ],
      },
    },
    {
      name: 'authorization_code',
      type: 'string',
      unique: true,
      interface: 'input',
      comment: 'One-time authorization code issued after approval',
      length: 255,
      validation: {
        type: 'string',
        rules: [{key: `r_${uid()}`, name: 'max', args: {length: 255}}],
      },
      uiSchema: {
        type: 'string',
        title: 'Authorization Code',
        'x-component': 'Input',
      },
    },
    {
      name: 'expires_at',
      type: 'datetimeTz',
      interface: 'datepicker',
      comment: 'Expiration timestamp of the authorization request',
      uiSchema: {
        type: 'datetime',
        title: 'Expires At',
        'x-component': 'DatePicker',
      },
    },
    {
      name: 'approved_at',
      type: 'datetimeTz',
      interface: 'datepicker',
      comment: 'Timestamp when the user approved the authorization',
      uiSchema: {
        type: 'datetime',
        title: 'Approved At',
        'x-component': 'DatePicker',
      },
    },
  ],
});
