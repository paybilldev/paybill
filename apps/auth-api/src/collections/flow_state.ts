import {defineCollection} from '@paybilldev/sequelize';

export default defineCollection({
  dumpRules: {group: 'auth'},
  migrationRules: ['schema-only', 'overwrite'],
  name: 'flow_state',
  title: 'Flow State',
  comment: 'Stores metadata for all OAuth/SSO login flows',
  model: 'FlowStateModel',
  createdBy: false,
  updatedBy: false,
  createdAt: true,
  updatedAt: true,
  logging: true,
  shared: false,
  indexes: [
    {
      fields: ['user_id', 'authentication_method'],
    },
  ],
  fields: [
    {
      name: 'id',
      type: 'uuid',
      primaryKey: true,
      interface: 'id',
      comment: 'Unique identifier for the flow state',
      uiSchema: {
        type: 'string',
        title: 'Flow ID',
        'x-component': 'Input',
        'x-read-pretty': true,
      },
    },
    {
      name: 'user',
      type: 'belongsTo',
      foreignKey: 'user_id',
      target: 'users',
      targetKey: 'id',
      interface: 'm2o',
      comment: 'Reference to the user associated with this flow',
      uiSchema: {
        type: 'array',
        title: 'User ID',
        'x-component': 'AssociationField',
        'x-component-props': {
          multiple: false,
          fieldNames: {label: 'id', value: 'id'},
        },
      },
    },
    {
      name: 'auth_code',
      type: 'string',
      interface: 'input',
      comment: 'Authorization code issued during the OAuth flow',
      uiSchema: {
        type: 'string',
        title: 'Auth Code',
        'x-component': 'Input',
      },
    },
    {
      name: 'auth_code_issued_at',
      type: 'datetimeTz',
      interface: 'datepicker',
      timestamps: false,
      comment: 'Timestamp when the auth code was issued',
      uiSchema: {
        type: 'datetime',
        title: 'Auth Code Issued At',
        'x-component': 'DatePicker',
      },
    },
    {
      name: 'code_challenge_method',
      type: 'string',
      interface: 'select',
      comment: 'PKCE code challenge method (S256 or plain)',
      uiSchema: {
        type: 'string',
        title: 'Code Challenge Method',
        'x-component': 'Select',
        enum: [
          {label: 'S256', value: 's256'},
          {label: 'Plain', value: 'plain'},
        ],
      },
    },
    {
      name: 'code_challenge',
      type: 'string',
      interface: 'input',
      comment: 'PKCE code challenge value for security',
      uiSchema: {
        type: 'string',
        title: 'Code Challenge',
        'x-component': 'Input',
      },
    },
    {
      name: 'provider_type',
      type: 'string',
      allowNull: false,
      interface: 'input',
      comment: 'Type of OAuth/SSO provider (e.g., Google, Facebook)',
      uiSchema: {
        type: 'string',
        title: 'Provider Type',
        'x-component': 'Input',
      },
    },
    {
      name: 'provider_access_token',
      type: 'string',
      interface: 'password',
      comment: 'Access token issued by the provider',
      uiSchema: {
        type: 'string',
        title: 'Provider Access Token',
        'x-component': 'Password',
      },
    },
    {
      name: 'provider_refresh_token',
      type: 'string',
      interface: 'password',
      comment: 'Refresh token issued by the provider',
      uiSchema: {
        type: 'string',
        title: 'Provider Refresh Token',
        'x-component': 'Password',
      },
    },
    {
      name: 'authentication_method',
      type: 'string',
      allowNull: false,
      interface: 'input',
      comment: 'Method used for authentication (OAuth, SSO, etc.)',
      uiSchema: {
        type: 'string',
        title: 'Authentication Method',
        'x-component': 'Input',
      },
    },
    {
      name: 'invite_token',
      type: 'string',
      interface: 'input',
      comment: 'Token used for user invitation flows',
      uiSchema: {
        type: 'string',
        title: 'Invite Token',
        'x-component': 'Input',
      },
    },
    {
      name: 'referrer',
      type: 'string',
      interface: 'input',
      comment: 'Optional referrer identifier for tracking',
      uiSchema: {
        type: 'string',
        title: 'Referrer',
        'x-component': 'Input',
      },
    },
    {
      name: 'oauth_client_state_id',
      type: 'uuid',
      interface: 'input',
      comment: 'State ID for OAuth client session tracking',
      uiSchema: {
        type: 'string',
        title: 'OAuth Client State ID',
        'x-component': 'Input',
      },
    },
    {
      name: 'linking_target_id',
      type: 'uuid',
      interface: 'input',
      comment: 'Target ID used when linking accounts together',
      uiSchema: {
        type: 'string',
        title: 'Linking Target ID',
        'x-component': 'Input',
      },
    },
    {
      name: 'email_optional',
      type: 'boolean',
      defaultValue: false,
      interface: 'checkbox',
      comment: 'Indicates if email is optional for this flow',
      uiSchema: {
        type: 'boolean',
        title: 'Email Optional',
        'x-component': 'Switch',
      },
    },
  ],
});
